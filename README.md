# Runtime Orchestrator

## Setup

### Quick Setup

- Make sure you have `python3` and `pip3`, and `virtualenv` installed.
- Clone and fetch subrepositories:
    ```sh
    git clone git@github.com:SilverLineFramework/orchestrator.git
    git submodule update --init --recursive
    ```
- Create virtualenv & database:
    ```sh
    make migrate
    ```
- Run server:
    ```sh
    make
    ```

### Manual Setup

- After cloning and fetching subrepositories, install python requirements:
    ```sh
    pip install -r requirements.txt
    pip install -r libsilverline/requirements.txt
    ```

- (Optional) Set up configuration in `config.json`. Using a configuration file generated by `configure.py` in [hc](https://github.com/SilverLineFramework/hc) is recommended, especially by `ln -s hc/config/hc.cfg orchestrator/config.json`.

    The default values used are:
    ```json
    {
        "http": "localhost",
        "http_port": 8000,
        "debug": true,
        "realm": "realm",
        "mqtt": "localhost",
        "mqtt_port": 1883,
        "use_ssl": false,
        "mqtt_username": "arts",
        "pwd": "mqtt_pwd.txt",
        "log_dir": ".",
    }
    ```

- (Optional) Create the **secret** `key.json` file for Django; should be generated locally (i.e. ```secrets.token_urlsafe(64)```), and only used locally. Schema:
    ```json
    {
        "key": "put_your_secret_key_here"
    }
    ```

- Make database:
    ```sh
    python3 manage.py migrate
    ```

- Make log directory:
    ```sh
    mkdir -p log
    ```

- Run server:
    ```sh
    python3 manage.py runserver
    ```

## Documentation

The Orchestrator is documented with [Sphinx](https://www.sphinx-doc.org/en/master/index.html) using
Numpy-style docstrings parsed by [Napoleon](https://sphinxcontrib-napoleon.readthedocs.io/en/latest/).

Run ```./build.sh``` to build.

## APIs

### MQTT

See the runtime [control messages](https://github.com/SilverLineFramework/runtime-linux/wiki/Control-Messages) for full documentation. We currently implement create and delete operations for runtimes and modules.

### REST

REST can only be used to fetch metadata:
- `api/runtimes/`: list of runtimes
    ```json
    {
        "runtimes": [
            {
                "uuid": "43a664a6-5c99-4b08-9d00-eeabc0d1f7f7",
                "name": "test",
                "runtime_type": "linux",
                "aot_target": "{}",
                "children": [
                    {
                        "uuid": "54c0d836-a23f-4ef7-8c64-4b6f5082b7a7",
                        "name": "module",
                        "filename": "wasm/polybench/2mm_s.wasm"
                    }
                ]
            }
        ]
    }
    ```
- `api/runtimes/{uuid}`: detailed metadata about a single runtime
    ```json
    {
        "uuid": "43a664a6-5c99-4b08-9d00-eeabc0d1f7f7",
        "name": "test",
        "apis": ["wasm", "wasi"],
        "runtime_type": "linux",
        "ka_interval_sec": 60,
        "page_size": 65536,
        "aot_target": "{}",
        "metadata": null,
        "alive": true
    }
    ```
- `api/modules`: list of modules
    ```json
    {
        "modules": [
            {
                "uuid": "54c0d836-a23f-4ef7-8c64-4b6f5082b7a7",
                "name": "module",
                "parent": "43a664a6-5c99-4b08-9d00-eeabc0d1f7f7",
                "filename": "wasm/polybench/2mm_s.wasm"
            }
        ]
    }
    ```
- `api/modules/{uuid}`: detailed metadata about a single module
    ```json
    {
        "uuid": "54c0d836-a23f-4ef7-8c64-4b6f5082b7a7",
        "name": "module",
        "parent": "43a664a6-5c99-4b08-9d00-eeabc0d1f7f7",
        "filename": "wasm/polybench/2mm_s.wasm",
        "filetype": "WA",
        "apis": ["wasm", "wasi"],
        "args": ["wasm/polybench/2mm_s.wasm"],
        "env": [],
        "channels": [],
        "peripherals": [],
        "resources": null,
        "alive": true
    }
    ```
