# Messages

When runtimes are communicating with ARTS, they do so by sending messages in the
JSON format. All messages contain an `object_id` field, which contains a unique
identifier for *that message* and is used to confirm transactions.

The types of messages are defined in the following table:

| Message                   | Direction                                |
|---------------------------|------------------------------------------|
| Register / Create Runtime | Runtime → ARTS                           |
| Keep Alive                | Runtime → ARTS                           |
| Delete Runtime            | Runtime → ARTS                           |
| Create Module             | Program or User → ARTS; ARTS → Runtime   |
| Delete Module             | Program or User or ARTS → Runtime        |

## Runtime Registration

```json
Runtime → ARTS
{
  "object_id": "50c2f088-a5b6-48c5-bbc7-4a693b0117a2",
  "action": "create",
  "type": "arts_req",
  "data": {
    "type": "runtime",
    "uuid": "5f937916-d29d-4f66-801e-3d69f57728e2",
    "name": "rt1",
    "max_nmodules": 10,
    "apis": [ "wasi:unstable wasi:snapshot_preview1" ]
  }
}
```

* The `object_id` is the id of the request, and that the `uuid` field is
  the id of the runtime (which is generated by the runtime).
* After receiving a registration request, ARTS will send a confirmation message
  back to the runtime in the following format.

```json
ARTS → Runtime
{
  "object_id": "50c2f088-a5b6-48c5-bbc7-4a693b0117e5",
  "type": "arts_resp",
  "data": {
    "result": "ok",
    "details": {
      "uuid": "5f937916-d29d-4f66-801e-3d69f57728e2",
      "name": "rt1",
      "apis": [ "wasi:unstable wasi:snapshot_preview1" ],
      "max_nmodules": 10,
      "nmodules": 0,
      "children": [ ],
      "ka_interval_sec": 60
    }
  }
}
```

* The `object_id` in the response will be the same id as in the request.
* The `details` field of the response will be mostly a reproduction of the
  `data` in the original message.
* `nmodules` stores the number of modules currently running
* `children` stores a list of the modules currently running
* `ka_interval_sec` indicates how often the runtime should send a heartbeat to
  ARTS, (0 = do not send)

## Keep Alive

```json
Runtime → ARTS
{
  "object_id": "50c2f088-a5b6-48c5-bbc7-4a693b0117a2",
  "action": "update",
  "type": "arts_req",
  "data": {
    "type": "runtime",
    "uuid": "5f937916-d29d-4f66-801e-3d69f57728e2",
    "name": "rt1",
    "apis": [ "wasi:unstable wasi:snapshot_preview1" ],
    "max_nmodules": 10,
    "nmodules": 1,
    "children": [
      {
        "uuid": "5f937916-d29d-4f66-801e-3d69f57728e2",
        "active": "2020-08-25T15:46:20.545Z"
      }
    ]
  }
}
```

* In `children`, `active` indicates the last time a module saw an I/O request

## Delete Runtime

```json
Runtime → ARTS
{
  "object_id": "9d6a1011-5fd2-4e34-9d15-c4adde3c7679",
  "action": "delete",
  "type": "arts_req",
  "data": {
    "type": "runtime",
    "uuid": "5f937916-d29d-4f66-801e-3d69f57728e2",
    "name": "rt1",
    "max_nmodules": 1,
    "apis": [ "wasi:unstable wasi:snapshot_preview1" ]
  }
}
```

* The `uuid` field is the runtime's UUID
* This message should be set as a runtime's MQTT last will

## Create Module Request

```json
Program or User → ARTS
{
  "object_id": "fcb2780b-abdd-43b6-bc13-895baa2075a3",
  "action": "create",
  "type": "arts_req",
  "data": {
    "type": "module",
    "uuid": "44c72c87-c4ec-4759-b587-30ddc8590f6b",
    "name": "test",
    "parent": {
      "uuid": "059ec980-c38f-4612-a655-cc4c1ef9624c"
    },
    "filename": "stdinread.wasm",
    "fileid": "na",
    "filetype": "WA",
    "apis": [ "wasi:snapshot_preview1" ],
    "args": [ "arg1", "arg2" ],
    "env": [ "ENV_VAR1=1", "ENV_VAR2=2" ],
    "channels": [
      {
        "path": "/ch/light",
        "type": "pubsub",
        "mode": "rw",
        "params": { "topic": "kitchen/light" }
      }
    ]
  }
}
```

* `uuid` in `data` is an identifier for the module
* `parent` allows for requesting which runtime the module runs in
* `fileid` is legacy
* `filetype` can either take "WA" (WASM) or "PY" (python)
* `apis` allows for specifying the apis the module requires to run
* `args` allows for command line arguments
* `env` allows for environment variables
* `channels` are explained in INSERT LINK HERE
* The following fields are optional:
  * `data[uuid]`
  * `data[parent]`
  * `data[apis]`
  * `data[args]`
  * `data[env]`
  * `data[channels]`
* The module requester sends the request first to ARTS, which can modify
  parameters and potentially change the runtime the module runs in, and then
  forwards the request to a runtime
* Each object in the `channels` array contains a `path` to a folder visible to
  the module, a `type` prefix, either "pubsub" or "client", a `mode` such as
  "rw" and `params` which are type specified parameters

## Delete Module Request

```json
ARTS → Runtime
{
  "object_id": "fcb2780b-abdd-43b6-bc13-895baa2075b4",
  "action": "delete",
  "type": "arts_req",
  "data": {
    "type": "module",
    "uuid": 44c72c87-c4ec-4759-b587-30ddc8590f6b",
    "send_to_runtime": "45772c87-ccd5-4759-b587-30ddc85e2f6e"
  }
}
```

* `send_to_runtime` is an optional parameter for where to send the request
